<!DOCTYPE html>
<html>
	<meta charset="utf-8">
	<title>Stream Hydrograph</title>
	<link rel="shortcut icon" href="favicon.ico" />
	<style>
		svg {
			font: 10px sans-serif;
		}

		path {
			fill: steelblue;
		}

		.axis path, .axis line {
			fill: none;
			stroke: #000;
			shape-rendering: crispEdges;
		}

		.brush .extent {
			stroke: #f55;
			fill-opacity: .125;
			shape-rendering: crispEdges;
		}

	</style>
	<body>
		<H1>Stream Hydrograph with HydroCloud</H1>
		<p>This page loads a file with 28,721 measurements and graphs it. The smaller version of the graph
		at the bottom of the page acts as the interface for panning and zooming on the larger graph, above.</p>
		<script src="d3/d3.v3.js"></script>
		<script>
		//This page is based on Mike Bostock's example of the brush component to pan and zoom: http://bl.ocks.org/1667367
			var margin = {
				top : 10,
				right : 10,
				bottom : 100,
				left : 70
			}, margin2 = {
				top : 430,
				right : 10,
				bottom : 20,
				left : 70
			}, width = 960 - margin.left - margin.right, height = 500 - margin.top - margin.bottom, height2 = 500 - margin2.top - margin2.bottom;

			var x = d3.time.scale().range([0, width]);
			var x2 = d3.time.scale().range([0, width]);
			var y = d3.scale.linear().range([height, 0]); //MR Having trouble changing from linear to log; maybe due to zeroes.
			var y2 = d3.scale.linear().range([height2, 0]);

			var xAxis = d3.svg.axis().scale(x).orient("bottom");
			var xAxis2 = d3.svg.axis().scale(x2).orient("bottom");
			var yAxis = d3.svg.axis().scale(y).orient("left");

			var brush = d3.svg.brush().x(x2).on("brush", brush);

			var area = d3.svg.area().interpolate("monotone").x(function(d) {
				return x(d.date);
			}).y0(height).y1(function(d) {
				return y(d.value);
			});

			var area2 = d3.svg.area().interpolate("monotone").x(function(d) {
				return x2(d.date);
			}).y0(height2).y1(function(d) {
				return y2(d.value);
			});

			var svg = d3.select("body").append("svg").attr("width", width + margin.left + margin.right).attr("height", height + margin.top + margin.bottom);

			svg.append("defs").append("clipPath").attr("id", "clip").append("rect").attr("width", width).attr("height", height);
			
			var focus = svg.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");

			var context = svg.append("g").attr("transform", "translate(" + margin2.left + "," + margin2.top + ")");

			var filename = "USGS01646500.txt";//MR added //a big file: 28,721 items in array.//demo must use .txt extension due to server.
			d3.json(filename, function (error, json) {//MR added
				if (error) return console.warn(error); //MR added
				//console.log(json.value.timeSeries[0].values[0].value);
				console.log(json);
				var data = json.value.timeSeries[0].values[0].value;//MR Create a new array of objects from the JSON.
				data.forEach(function(d) {
					d.date = new Date(d.dateTime);//MR add a new property called date which we'll use from here on out.
					d.value = +d.value;
				});
				var sitename = json.value.timeSeries[0].sourceInfo.siteName;
				//console.log(sitename);

				x.domain(d3.extent(data.map(function(d) {
					return d.date;
				})));
				y.domain([0, d3.max(data.map(function(d) {
					return d.value;
				}))]);
				x2.domain(x.domain());
				y2.domain(y.domain());

				focus.append("path").datum(data).attr("clip-path", "url(#clip)").attr("d", area);

				focus.append("g").attr("class", "x axis").attr("transform", "translate(0," + height + ")").call(xAxis);

				focus.append("g").attr("class", "y axis").call(yAxis);

				context.append("path").datum(data).attr("d", area2);

				context.append("g").attr("class", "x axis").attr("transform", "translate(0," + height2 + ")").call(xAxis2);

				context.append("g").attr("class", "x brush").call(brush).selectAll("rect").attr("y", -6).attr("height", height2 + 7);
				
				svg.append("svg:text").attr("x", margin.left + 15).attr("y", margin.top + 20).attr("font-size", 20).text(sitename);
				svg.append("svg:text").attr("x", margin.left + 15).attr("y", margin.top + 35).attr("font-size", 12).text(data.length + " elements");
				var yLabel = svg.append("g").attr("class", "y-label").attr("transform","rotate(-90)");//create a group that is rotated, add a text label to it.
				yLabel.append("svg:text").attr("x", (margin.top + height/2 + 48)*-1).attr("y", 10).attr("font-size", 14).text("Discharge (cfs)");//48 is half the width of the text I am displaying.

			});

			function brush() {
				x.domain(brush.empty() ? x2.domain() : brush.extent());
				focus.select("path").attr("d", area);
				focus.select(".x.axis").call(xAxis);
			}

		</script>
	</body>
</html>
